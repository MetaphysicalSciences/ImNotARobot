<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no">
<title>Snake XP Ultra Plus</title>
<style>
html,body{height:100%;margin:0;padding:0;overflow:hidden;background:linear-gradient(#007070,#004c4c);font-family:Tahoma,Arial,sans-serif;-webkit-user-select:none;-ms-user-select:none;user-select:none;touch-action:none}
#app{position:relative;width:100%;height:100%;overflow:hidden}
canvas{display:block;width:100%;height:100%;background:transparent}
.window{position:absolute;background:#c0c0c0;border:4px outset #fff;box-shadow:6px 6px 0 rgba(0,0,0,0.2);padding:10px;border-radius:2px}
.titlebar{display:flex;align-items:center;justify-content:space-between;background:linear-gradient(#0c5a5a,#084c4c);color:#fff;padding:6px 8px;font-weight:bold;border:2px inset rgba(255,255,255,0.1)}
.titlebar .buttons{display:flex;gap:6px}
.btn{width:16px;height:14px;border-radius:2px;background:#c0392b;box-shadow:inset 0 -2px rgba(0,0,0,0.2)}
.btn.min{background:#f39c12}
.btn.max{background:#2ecc71}
.center{display:flex;align-items:center;justify-content:center}
#mainMenu.window{left:5%;top:5%;width:340px;height:360px}
#settings.window{left:10%;top:5%;width:520px;height:80%;overflow:hidden;display:none}
#gameOver.window{left:50%;top:40%;transform:translate(-50%,-50%);width:420px;height:240px;display:none}
.menuButtons{display:flex;flex-direction:column;gap:8px;margin-top:20px}
.menuButtons button{padding:10px;background:#007acc;border:none;color:#fff;font-weight:bold;cursor:pointer;border-radius:3px;box-shadow:inset 0 -3px rgba(0,0,0,0.15)}
.menuFooter{margin-top:12px;color:#333;font-size:12px}
#settingsHeader{display:flex;align-items:center;justify-content:space-between;padding:8px;background:linear-gradient(#e6e6e6,#cfcfcf);border-bottom:2px inset rgba(255,255,255,0.6)}
#settingsList{height:calc(100% - 64px);overflow:auto;padding:12px;display:flex;flex-direction:column;gap:8px;background:linear-gradient(#f5f5f5,#e8e8e8)}
.settingRow{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:6px;border-radius:4px;background:#fff;border:1px solid #d0d0d0}
.settingRow label{flex:1;font-size:14px;color:#222}
.settingRow input[type="range"]{width:180px}
.settingRow select,input[type="color"],input[type="number"]{margin-left:8px}
#hud{position:absolute;left:50%;top:8px;transform:translateX(-50%);background:rgba(0,0,0,0.4);color:#fff;padding:6px 12px;border-radius:6px;font-weight:bold;z-index:6;box-shadow:0 2px 6px rgba(0,0,0,0.6)}
#joystick{position:absolute;bottom:50px;left:50px;width:100px;height:100px;border-radius:50%;background:rgba(255,255,255,0.12);touch-action:none;z-index:5;display:flex;align-items:center;justify-content:center;border:2px solid rgba(255,255,255,0.08)}
#stick{width:34px;height:34px;border-radius:50%;background:linear-gradient(#ffffff,#dddddd);box-shadow:0 3px 6px rgba(0,0,0,0.3)}
.footerBar{position:absolute;right:10px;bottom:10px;background:rgba(255,255,255,0.06);padding:6px 8px;color:#fff;border-radius:4px;font-size:12px}
.scrollHint{font-size:12px;color:#666;margin-top:6px}
input[type="checkbox"]{transform:scale(1.1);margin-left:6px}
.switch{display:inline-flex;align-items:center;gap:6px}
.menuTitle{font-size:22px;color:#004a4a}
.windowSmall{width:240px;height:200px}
.scoreBox{display:flex;gap:12px;align-items:center}
.smallBtn{padding:6px 10px;background:#007acc;color:#fff;border:none;border-radius:3px;cursor:pointer}
.legend{font-size:12px;color:#222;margin-top:8px}
</style>
</head>
<body>
<div id="app">
<canvas id="c"></canvas>

<div id="mainMenu" class="window">
<div class="titlebar"><div>Snake XP Ultra Plus</div><div class="buttons"><div class="btn"></div><div class="btn min"></div><div class="btn max"></div></div></div>
<div style="padding:12px">
<div class="menuTitle">A Retro XP Snake</div>
<div class="menuButtons">
<button id="startBtn">Play</button>
<button id="settingsBtn">Settings</button>
<button id="howBtn">How to play</button>
<button id="creditsBtn">Credits</button>
</div>
<div class="menuFooter">Touch joystick, customize everything. Retro XP skin.</div>
</div>
</div>

<div id="settings" class="window">
<div id="settingsHeader">
<div style="display:flex;flex-direction:column"><strong>Settings</strong><span class="scrollHint">Scroll to see many options</span></div>
<div><button id="settingsBack" class="smallBtn">Back</button></div>
</div>
<div id="settingsList"></div>
</div>

<div id="gameOver" class="window">
<div class="titlebar"><div id="loseTitle">You Lost</div><div></div></div>
<div style="padding:12px;display:flex;flex-direction:column;align-items:center;gap:8px">
<div id="finalText" style="font-size:18px;color:#111">Score: 0</div>
<div style="display:flex;gap:8px"><button id="retryBtn" class="smallBtn">Retry</button><button id="menuBtn" class="smallBtn">Main Menu</button></div>
<div class="legend">Tip: Tail hit reduces segments and score. Customize in Settings.</div>
</div>
</div>

<div id="hud">Score: 0 &nbsp; Lives: 3 &nbsp; FPS: <span id="fps">0</span></div>
<div id="joystick"><div id="stick"></div></div>
<div class="footerBar">Mode: Classic XP</div>
</div>

<script>
const canvas=document.getElementById('c');
const ctx=canvas.getContext('2d');
let DPR=window.devicePixelRatio||1;
function resize(){canvas.width=innerWidth*DPR;canvas.height=innerHeight*DPR;canvas.style.width=innerWidth+'px';canvas.style.height=innerHeight+'px';ctx.setTransform(DPR,0,0,DPR,0,0)}
resize();addEventListener('resize',resize);

let grid=20;
let cols=Math.floor(innerWidth/grid);
let rows=Math.floor(innerHeight/grid);
function recalcGrid(){cols=Math.floor(innerWidth/grid);rows=Math.floor(innerHeight/grid)}

let snake=[];
let headPos={x:10,y:10};
let velocity={x:1,y:0};
let nextV={x:1,y:0};
let smoothPositions=[];
let speed=10;
let baseSpeed=10;
let score=0;
let lives=3;
let fruits=[];
let frame=0;
let running=false;
let lastTime=performance.now();
let fpsCounter=0;
let fpsTimer=performance.now();
let fpsShow=0;

let particles=[];
let particleMax=100;
let settingsMap={joystickSize:100,snakeColor:'#00ff00',snakeShape:'square',speed:10,particleCount:100,bgColor:'#000000',fruitSize:18,rareChance:10,trailOpacity:0.85,scoreFont:22,joystickOpacity:0.12,stickOpacity:1.0,snakeGlow:6,fruitGlow:6,particleSpeed:4,animSpeed:10,tailMult:1,gridSize:20,wrap:true,wallKill:false,showGrid:false,soundOn:false,vibrateOnEat:false,initialLength:3,maxParticles:300,particleColor:'#ffffff',fpsLimit:60,edgeFade:true,enableKeyboard:true,autoSmooth:true,reverseControls:false,fruitSpawnRate:0.02,seed:'',randomizeSeed:false}
const settingsOrder=[]

function setDefaultSettings(){
settingsMap.joystickSize=100
settingsMap.snakeColor='#00ff00'
settingsMap.snakeShape='4d'
settingsMap.speed=10
settingsMap.particleCount=100
settingsMap.bgColor='#001b1b'
settingsMap.fruitSize=18
settingsMap.rareChance=10
settingsMap.trailOpacity=0.9
settingsMap.scoreFont=22
settingsMap.joystickOpacity=0.14
settingsMap.stickOpacity=1
settingsMap.snakeGlow=6
settingsMap.fruitGlow=6
settingsMap.particleSpeed=4
settingsMap.animSpeed=10
settingsMap.tailMult=1
settingsMap.gridSize=20
settingsMap.wrap=true
settingsMap.wallKill=false
settingsMap.showGrid:false
settingsMap.soundOn:false
settingsMap.vibrateOnEat:false
settingsMap.initialLength=4
settingsMap.maxParticles=300
settingsMap.particleColor='#ffffff'
settingsMap.fpsLimit=60
settingsMap.edgeFade=true
settingsMap.enableKeyboard=true
settingsMap.autoSmooth=true
settingsMap.reverseControls=false
settingsMap.fruitSpawnRate=0.02
settingsMap.seed=''
settingsMap.randomizeSeed=false
}
setDefaultSettings()

function rngFactory(seed){
let x=0
for(let i=0;i<seed.length;i++) x=(x*31+seed.charCodeAt(i))|0
if(x===0) x=1
return function(){x=(x*1664525+1013904223)|0;return ((x>>>0)/4294967296)}
}

let rng=Math.random;
function applySeed(){if(settingsMap.randomizeSeed||!settingsMap.seed) rng=Math.random; else rng=rngFactory(settingsMap.seed)}

applySeed()

function initParticles(){
particles=[]
for(let i=0;i<settingsMap.particleCount;i++){
particles.push({x:Math.random()*innerWidth,y:Math.random()*innerHeight,vx:(Math.random()-0.5)*settingsMap.particleSpeed,vy:(Math.random()-0.5)*settingsMap.particleSpeed,size:Math.random()*3+1,color:settingsMap.particleColor,alpha:Math.random()})
}
}

initParticles()

function newGame(){
applySeed()
grid=settingsMap.gridSize
recalcGrid()
snake=[]
for(let i=0;i<settingsMap.initialLength;i++) snake.push({x:10-i,y:10})
headPos={x:10,y:10}
velocity={x:1,y:0}
nextV={x:1,y:0}
smoothPositions=[]
for(let i=0;i<snake.length;i++) smoothPositions.push({x:snake[i].x,y:snake[i].y})
score=0
lives=3
fruits=[]
spawnInitialFruits()
running=true
frame=0
initParticles()
hudUpdate()
}

function spawnInitialFruits(){
for(let i=0;i<11;i++) spawnFruit(true)
}

const FRUIT_TYPES=[
{color:'#ff2e2e',grow:1,score:1,name:'Apple'},
{color:'#ffd12e',grow:2,score:3,name:'Banana'},
{color:'#2ee7ff',grow:3,score:5,name:'Blue Diamond'},
{color:'#adff2e',grow:1,score:2,name:'Lime'},
{color:'#ff7ad1',grow:0,score:0,name:'Shrinker',effect:(g)=>{if(g.length>3) for(let i=0;i<2;i++) g.pop()}},
{color:'#ffaa00',grow:2,score:4,name:'Speedup',effect:(g)=>{baseSpeed=Math.min(25,baseSpeed+3);setTimeout(()=>baseSpeed=10,4000)}},
{color:'#7c3cff',grow:3,score:6,name:'Multiplier',effect:(g)=>{score+=5}},
{color:'#00ff99',grow:2,score:3,name:'Teleport',effect:(g)=>{let hx=Math.floor(Math.random()*cols);let hy=Math.floor(Math.random()*rows);g[0].x=hx;g[0].y=hy}},
{color:'#ff0055',grow:0,score:-5,name:'Poison',effect:(g)=>{for(let i=0;i<2;i++) if(g.length>1) g.pop();score=Math.max(0,score-2)}},
{color:'#a0a0a0',grow:0,score:0,name:'Bomb',effect:(g)=>{if(g.length>3) g.splice(1,Math.min(4,g.length-1));score=Math.max(0,score-1)}},
{color:'#ffffff',grow:0,score:0,name:'ExtraLife',effect:(g)=>{lives++}}
]

function fruitTypeByIndex(i){return FRUIT_TYPES[i%FRUIT_TYPES.length]}

function spawnFruit(ensureSafe=false){
let attempts=0
while(attempts<200){
attempts++
let x=Math.floor(rng()*cols)
let y=Math.floor(rng()*rows)
let collision=false
for(let s of snake) if(s.x===x&&s.y===y) collision=true
for(let f of fruits) if(f.x===x&&f.y===y) collision=true
if(!collision){
let rare=rng()*100<settingsMap.rareChance
let typeIndex=Math.floor(rng()*FRUIT_TYPES.length)
if(rare) typeIndex=Math.min(FRUIT_TYPES.length-1,Math.floor(rng()*FRUIT_TYPES.length))
fruits.push({x,y,type:typeIndex})
return
}
}
}

function perfectCollisionCheck(x,y){
for(let s of snake) if(s.x===x&&s.y===y) return true
return false
}

function eatFruitAt(x,y){
for(let i=0;i<fruits.length;i++){
if(fruits[i].x===x&&fruits[i].y===y){
let t=FRUIT_TYPES[fruits[i].type]
score+=t.score
let grow=(t.grow||0)*settingsMap.tailMult
for(let g=0;g<grow;g++) snake.push({...snake[snake.length-1]})
if(t.effect) t.effect(snake)
if(settingsMap.vibrateOnEat && navigator.vibrate) navigator.vibrate(30)
fruits.splice(i,1)
spawnFruit()
hudUpdate()
return true
}
}
return false
}

function hudUpdate(){
document.getElementById('hud').innerHTML=`Score: ${score} &nbsp; Lives: ${lives} &nbsp; FPS: <span id="fps">${fpsShow}</span>`
}

function drawXPWindowDecor(){
let w=innerWidth,h=innerHeight
ctx.save()
ctx.globalCompositeOperation='source-over'
ctx.fillStyle='rgba(255,255,255,0.03)'
ctx.fillRect(6,6,220,44)
ctx.restore()
}

function drawBackground(){
ctx.fillStyle=settingsMap.bgColor
ctx.fillRect(0,0,innerWidth,innerHeight)
if(settingsMap.edgeFade){
let g=ctx.createLinearGradient(0,0,0,innerHeight)
g.addColorStop(0,'rgba(0,0,0,0.25)')
g.addColorStop(0.4,'rgba(0,0,0,0)')
g.addColorStop(0.6,'rgba(0,0,0,0)')
g.addColorStop(1,'rgba(0,0,0,0.25)')
ctx.fillStyle=g
ctx.fillRect(0,0,innerWidth,innerHeight)
}
if(settingsMap.showGrid){
ctx.save();ctx.strokeStyle='rgba(255,255,255,0.03)';ctx.lineWidth=1
for(let i=0;i<cols;i++){ctx.beginPath();ctx.moveTo(i*grid,0);ctx.lineTo(i*grid,innerHeight);ctx.stroke()}
for(let j=0;j<rows;j++){ctx.beginPath();ctx.moveTo(0,j*grid);ctx.lineTo(innerWidth,j*grid);ctx.stroke()}
ctx.restore()
}
}

function drawParticles(){
for(let p of particles){
ctx.fillStyle=`rgba(255,255,255,${p.alpha})`
ctx.fillRect(p.x,p.y,p.size,p.size)
p.x+=p.vx
p.y+=p.vy
if(p.x<0||p.x>innerWidth) p.vx*=-1
if(p.y<0||p.y>innerHeight) p.vy*=-1
}
}

function drawFruits(){
for(let f of fruits){
let t=FRUIT_TYPES[f.type]
ctx.save()
ctx.shadowColor=t.color
ctx.shadowBlur=settingsMap.fruitGlow
ctx.fillStyle=t.color
let px=f.x*grid,py=f.y*grid
let s=settingsMap.fruitSize
ctx.fillRect(px+1,py+1,s-2,s-2)
ctx.restore()
}
}

function drawSnakeSmooth(){
for(let i=0;i<smoothPositions.length;i++){
let s=smoothPositions[i]
let factor=(i/smoothPositions.length)
let col=settingsMap.snakeColor
ctx.save()
ctx.globalAlpha=1
ctx.shadowColor=settingsMap.snakeColor
ctx.shadowBlur=settingsMap.snakeGlow*(1-factor)
if(settingsMap.snakeShape==='square'){
ctx.fillStyle=col
ctx.fillRect(s.x*grid+1,s.y*grid+1,grid-2,grid-2)
}else if(settingsMap.snakeShape==='circle'){
ctx.beginPath();ctx.fillStyle=col;ctx.arc(s.x*grid+grid/2,s.y*grid+grid/2,grid/2-1,0,Math.PI*2);ctx.fill()
}else if(settingsMap.snakeShape==='rounded'){
ctx.fillStyle=col;ctx.fillRect(s.x*grid+3,s.y*grid+3,grid-6,grid-6);ctx.beginPath();ctx.arc(s.x*grid+grid/2,s.y*grid+grid/2,grid/2-5,0,Math.PI*2);ctx.fill()
}else if(settingsMap.snakeShape==='4d'){
let cx=s.x*grid+grid/2,cy=s.y*grid+grid/2
let t=(performance.now()/1000+ i*0.2)*0.9
let r=grid*0.45
let dx=Math.cos(t)*r,dy=Math.sin(t)*r
ctx.beginPath()
ctx.moveTo(cx-dx,cy-dy)
ctx.lineTo(cx+dy,cy-dx)
ctx.lineTo(cx+dx,cy+dy)
ctx.lineTo(cx-dy,cy+dx)
ctx.closePath()
ctx.fillStyle=col
ctx.fill()
ctx.strokeStyle='rgba(255,255,255,0.12)'
ctx.stroke()
}
ctx.restore()
}
}

function step(){
let now=performance.now()
let dt=Math.min(60,(now-lastTime))/1000
lastTime=now
fpsCounter++
if(now-fpsTimer>500){
fpsShow=Math.round((fpsCounter*1000)/(now-fpsTimer))
fpsCounter=0;fpsTimer=now
document.getElementById('fps')&& (document.getElementById('fps').textContent=fpsShow)
}
if(!running) return
frame++
let tickInterval=1/(settingsMap.fpsLimit||60)
if(frame%(Math.max(1,Math.floor(60/(baseSpeed||10))))!==0 && !settingsMap.autoSmooth) return
velocity=nextV
if(settingsMap.reverseControls) velocity={x:-velocity.x,y:-velocity.y}
let newHead={x:headPos.x+velocity.x,y:headPos.y+velocity.y}
if(newHead.x<0){ if(settingsMap.wrap) newHead.x=cols-1; else if(settingsMap.wallKill){loseLife();return}else newHead.x=0}
if(newHead.x>=cols){ if(settingsMap.wrap) newHead.x=0; else if(settingsMap.wallKill){loseLife();return}else newHead.x=cols-1}
if(newHead.y<0){ if(settingsMap.wrap) newHead.y=rows-1; else if(settingsMap.wallKill){loseLife();return}else newHead.y=0}
if(newHead.y>=rows){ if(settingsMap.wrap) newHead.y=0; else if(settingsMap.wallKill){loseLife();return}else newHead.y=rows-1}
for(let i=0;i<snake.length;i++){
if(snake[i].x===newHead.x && snake[i].y===newHead.y){
score=Math.max(0,score-2)
for(let k=0;k<2;k++) if(snake.length>1) snake.pop()
if(snake.length<=1){gameOver();return}
hudUpdate()
break
}
}
snake.unshift(newHead)
headPos=newHead
if(!eatFruitAt(headPos.x,headPos.y)) snake.pop()
if(rng()<settingsMap.fruitSpawnRate) spawnFruit()
updateSmoothPositions(dt)
}

function updateSmoothPositions(dt){
smoothPositions=[]
for(let i=0;i<snake.length;i++){
let s=snake[i]
smoothPositions.push({x:s.x,y:s.y})
}
}

function loseLife(){
lives--
if(lives<=0){gameOver();return}
hudUpdate()
}

function gameOver(){
running=false
document.getElementById('gameOver').style.display='block'
document.getElementById('finalText').textContent=`Final Score: ${score}`
}

function render(){
ctx.clearRect(0,0,innerWidth,innerHeight)
drawBackground()
drawParticles()
drawFruits()
drawSnakeSmooth()
drawXPWindowDecor()
hudUpdate()
}

function loop(){
step()
render()
requestAnimationFrame(loop)
}

loop()

document.getElementById('startBtn').addEventListener('click',()=>{
document.getElementById('mainMenu').style.display='none'
document.getElementById('settings').style.display='none'
document.getElementById('gameOver').style.display='none'
newGame()
})

document.getElementById('settingsBtn').addEventListener('click',()=>{
document.getElementById('mainMenu').style.display='none'
document.getElementById('settings').style.display='block'
buildSettingsUI()
})

document.getElementById('settingsBack').addEventListener('click',()=>{
document.getElementById('settings').style.display='none'
document.getElementById('mainMenu').style.display='block'
applySettingsFromUI()
})

document.getElementById('retryBtn').addEventListener('click',()=>{
document.getElementById('gameOver').style.display='none'
newGame()
})

document.getElementById('menuBtn').addEventListener('click',()=>{
document.getElementById('gameOver').style.display='none'
document.getElementById('mainMenu').style.display='block'
})

let startTouch=false,stickActive=false,jsStartX=0,jsStartY=0
const joystick=document.getElementById('joystick')
const stick=document.getElementById('stick')
function updateJoystickVisual(size,joOpacity,stOpacity){
joystick.style.width=joystick.style.height=size+'px'
joystick.style.opacity=joOpacity
stick.style.opacity=stOpacity
stick.style.width=Math.max(28,size*0.32)+'px'
stick.style.height=Math.max(28,size*0.32)+'px'
}
updateJoystickVisual(settingsMap.joystickSize,settingsMap.joystickOpacity,settingsMap.stickOpacity)

joystick.addEventListener('touchstart',e=>{
e.preventDefault()
stickActive=true
let t=e.touches[0]
jsStartX=t.clientX;jsStartY=t.clientY
})
joystick.addEventListener('touchmove',e=>{
if(!stickActive) return
e.preventDefault()
let t=e.touches[0]
let dx=t.clientX-jsStartX,dy=t.clientY-jsStartY
let mx=Math.abs(dx),my=Math.abs(dy)
if(mx>my){ if(dx>0 && velocity.x!==-1) nextV={x:1,y:0}; if(dx<0 && velocity.x!==1) nextV={x:-1,y:0} } else { if(dy>0 && velocity.y!==-1) nextV={x:0,y:1}; if(dy<0 && velocity.y!==1) nextV={x:0,y:-1} }
let dist=Math.min((settingsMap.joystickSize/2)-8, Math.hypot(dx,dy))
let angle=Math.atan2(dy,dx)
stick.style.transform=`translate(${dist*Math.cos(angle)}px,${dist*Math.sin(angle)}px)`
})
joystick.addEventListener('touchend',e=>{
stickActive=false
stick.style.transform='translate(0,0)'
})

if(settingsMap.enableKeyboard){
window.addEventListener('keydown',e=>{
if(!running) return
if(e.key==='ArrowUp'&&velocity.y!==1) nextV={x:0,y:-1}
if(e.key==='ArrowDown'&&velocity.y!==-1) nextV={x:0,y:1}
if(e.key==='ArrowLeft'&&velocity.x!==1) nextV={x:-1,y:0}
if(e.key==='ArrowRight'&&velocity.x!==-1) nextV={x:1,y:0}
})
}

function buildSettingsUI(){
let container=document.getElementById('settingsList')
container.innerHTML=''
function rowHTML(label,el){let r=document.createElement('div');r.className='settingRow';let L=document.createElement('label');L.textContent=label;L.style.minWidth='160px';r.appendChild(L);r.appendChild(el);return r}
let elems=[]
let s=document.createElement('input');s.type='range';s.min=50;s.max=180;s.value=settingsMap.joystickSize;s.oninput=()=>settingsMap.joystickSize=+s.value;elems.push(rowHTML('Joystick Size',s))
let c=document.createElement('input');c.type='color';c.value=settingsMap.snakeColor;c.onchange=()=>settingsMap.snakeColor=c.value;elems.push(rowHTML('Snake Color',c))
let sh=document.createElement('select');['square','circle','rounded','4d'].forEach(v=>{let o=document.createElement('option');o.value=v;o.textContent=v;o.selected=(settingsMap.snakeShape===v);sh.appendChild(o)});sh.onchange=()=>settingsMap.snakeShape=sh.value;elems.push(rowHTML('Snake Shape',sh))
let sp=document.createElement('input');sp.type='range';sp.min=6;sp.max=25;sp.value=settingsMap.speed;sp.oninput=()=>settingsMap.speed=+sp.value;elems.push(rowHTML('Snake Speed',sp))
let g=document.createElement('input');g.type='range';g.min=0;g.max=500;g.value=settingsMap.particleCount;g.oninput=()=>settingsMap.particleCount=+g.value;elems.push(rowHTML('Particle Count',g))
let bg=document.createElement('input');bg.type='color';bg.value=settingsMap.bgColor;bg.onchange=()=>settingsMap.bgColor=bg.value;elems.push(rowHTML('Background Color',bg))
let fs=document.createElement('input');fs.type='range';fs.min=8;fs.max=32;fs.value=settingsMap.fruitSize;fs.oninput=()=>settingsMap.fruitSize=+fs.value;elems.push(rowHTML('Fruit Size',fs))
let rc=document.createElement('input');rc.type='range';rc.min=0;rc.max=50;rc.value=settingsMap.rareChance;rc.oninput=()=>settingsMap.rareChance=+rc.value;elems.push(rowHTML('Rare Fruit Chance (%)',rc))
let to=document.createElement('input');to.type='range';to.min=0;to.max=1;to.step=0.01;to.value=settingsMap.trailOpacity;to.oninput=()=>settingsMap.trailOpacity=+to.value;elems.push(rowHTML('Trail Opacity',to))
let sf=document.createElement('input');sf.type='range';sf.min=12;sf.max=40;sf.value=settingsMap.scoreFont;sf.oninput=()=>settingsMap.scoreFont=+sf.value;elems.push(rowHTML('Score Font Size',sf))
let joOp=document.createElement('input');joOp.type='range';joOp.min=0;joOp.max=1;joOp.step=0.01;joOp.value=settingsMap.joystickOpacity;joOp.oninput=()=>settingsMap.joystickOpacity=+joOp.value;elems.push(rowHTML('Joystick Opacity',joOp))
let stOp=document.createElement('input');stOp.type='range';stOp.min=0;stOp.max=1;stOp.step=0.01;stOp.value=settingsMap.stickOpacity;stOp.oninput=()=>settingsMap.stickOpacity=+stOp.value;elems.push(rowHTML('Stick Opacity',stOp))
let sg=document.createElement('input');sg.type='range';sg.min=0;sg.max=30;sg.value=settingsMap.snakeGlow;sg.oninput=()=>settingsMap.snakeGlow=+sg.value;elems.push(rowHTML('Snake Glow',sg))
let fg=document.createElement('input');fg.type='range';fg.min=0;fg.max=30;fg.value=settingsMap.fruitGlow;fg.oninput=()=>settingsMap.fruitGlow=+fg.value;elems.push(rowHTML('Fruit Glow',fg))
let ps=document.createElement('input');ps.type='range';ps.min=1;ps.max=20;ps.value=settingsMap.particleSpeed;ps.oninput=()=>settingsMap.particleSpeed=+ps.value;elems.push(rowHTML('Particle Speed',ps))
let an=document.createElement('input');an.type='range';an.min=1;an.max=30;an.value=settingsMap.animSpeed;an.oninput=()=>settingsMap.animSpeed=+an.value;elems.push(rowHTML('Animation Speed',an))
let tm=document.createElement('input');tm.type='range';tm.min=1;tm.max=6;tm.value=settingsMap.tailMult;tm.oninput=()=>settingsMap.tailMult=+tm.value;elems.push(rowHTML('Tail Length Multiplier',tm))
let gs=document.createElement('input');gs.type='range';gs.min=10;gs.max=48;gs.value=settingsMap.gridSize;gs.oninput=()=>settingsMap.gridSize=+gs.value;elems.push(rowHTML('Grid Size',gs))
let wrap=document.createElement('input');wrap.type='checkbox';wrap.checked=settingsMap.wrap;wrap.onchange=()=>settingsMap.wrap=wrap.checked;elems.push(rowHTML('Wrap Around',wrap))
let wkill=document.createElement('input');wkill.type='checkbox';wkill.checked=settingsMap.wallKill;wkill.onchange=()=>settingsMap.wallKill=wkill.checked;elems.push(rowHTML('Wall Kills',wkill))
let showg=document.createElement('input');showg.type='checkbox';showg.checked=settingsMap.showGrid;showg.onchange=()=>settingsMap.showGrid=showg.checked;elems.push(rowHTML('Show Grid',showg))
let sound=document.createElement('input');sound.type='checkbox';sound.checked=settingsMap.soundOn;sound.onchange=()=>settingsMap.soundOn=sound.checked;elems.push(rowHTML('Sound On',sound))
let vib=document.createElement('input');vib.type='checkbox';vib.checked=settingsMap.vibrateOnEat;vib.onchange=()=>settingsMap.vibrateOnEat=vib.checked;elems.push(rowHTML('Vibrate On Eat',vib))
let initLen=document.createElement('input');initLen.type='number';initLen.min=1;initLen.max=20;initLen.value=settingsMap.initialLength;initLen.oninput=()=>settingsMap.initialLength=+initLen.value;elems.push(rowHTML('Initial Length',initLen))
let maxP=document.createElement('input');maxP.type='number';maxP.min=0;maxP.max=1000;maxP.value=settingsMap.maxParticles;maxP.oninput=()=>settingsMap.maxParticles=+maxP.value;elems.push(rowHTML('Max Particles',maxP))
let pColor=document.createElement('input');pColor.type='color';pColor.value=settingsMap.particleColor;pColor.onchange=()=>settingsMap.particleColor=pColor.value;elems.push(rowHTML('Particle Color',pColor))
let fps=document.createElement('input');fps.type='range';fps.min=15;fps.max=120;fps.value=settingsMap.fpsLimit;fps.oninput=()=>settingsMap.fpsLimit=+fps.value;elems.push(rowHTML('FPS Limit',fps))
let edge=document.createElement('input');edge.type='checkbox';edge.checked=settingsMap.edgeFade;edge.onchange=()=>settingsMap.edgeFade=edge.checked;elems.push(rowHTML('Edge Fade',edge))
let kb=document.createElement('input');kb.type='checkbox';kb.checked=settingsMap.enableKeyboard;kb.onchange=()=>settingsMap.enableKeyboard=kb.checked;elems.push(rowHTML('Enable Keyboard',kb))
let auto=document.createElement('input');auto.type='checkbox';auto.checked=settingsMap.autoSmooth;auto.onchange=()=>settingsMap.autoSmooth=auto.checked;elems.push(rowHTML('Auto Smooth Tick',auto))
let rev=document.createElement('input');rev.type='checkbox';rev.checked=settingsMap.reverseControls;rev.onchange=()=>settingsMap.reverseControls=rev.checked;elems.push(rowHTML('Reverse Controls',rev))
let fsp=document.createElement('input');fsp.type='range';fsp.min=0;fsp.max=0.1;fsp.step=0.005;fsp.value=settingsMap.fruitSpawnRate;fsp.oninput=()=>settingsMap.fruitSpawnRate=+fsp.value;elems.push(rowHTML('Fruit Spawn Rate',fsp))
let seedInput=document.createElement('input');seedInput.type='text';seedInput.placeholder='seed (optional)';seedInput.value=settingsMap.seed;seedInput.oninput=()=>settingsMap.seed=seedInput.value;elems.push(rowHTML('Seed',seedInput))
let randSeed=document.createElement('input');randSeed.type='checkbox';randSeed.checked=settingsMap.randomizeSeed;randSeed.onchange=()=>settingsMap.randomizeSeed=randSeed.checked;elems.push(rowHTML('Randomize Seed',randSeed))

for(let e of elems) container.appendChild(e)
}

function applySettingsFromUI(){
settingsMap.joystickSize=+document.querySelector('#settingsList input[type=range]')?.value || settingsMap.joystickSize
updateJoystickVisual(settingsMap.joystickSize,settingsMap.joystickOpacity,settingsMap.stickOpacity)
grid=settingsMap.gridSize
recalcGrid()
initParticles()
}

document.addEventListener('touchmove',function(e){if(e.scale!==1) e.preventDefault()},{passive:false})
document.addEventListener('gesturestart',e=>e.preventDefault())
document.addEventListener('dblclick',e=>e.preventDefault())

(function ensureInitialUI(){buildSettingsUI()})()
</script>
</body>
</html>
