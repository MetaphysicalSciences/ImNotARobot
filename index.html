<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>Babylon Physics Playground</title>
<style>
html,body{width:100%;height:100%;margin:0;overflow:hidden;touch-action:none;-webkit-touch-callout:none;-webkit-user-select:none;-ms-user-select:none;user-select:none;}
canvas{width:100%;height:100%;display:block;}
.joystick{position:absolute;width:clamp(72px,12vw,120px);height:clamp(72px,12vw,120px);border-radius:50%;background:rgba(0,0,0,0.28);backdrop-filter:blur(2px);-webkit-tap-highlight-color:transparent;touch-action:none;}
.joystick-inner{position:absolute;width:50%;height:50%;border-radius:50%;background:rgba(0,0,0,0.48);left:25%;top:25%;}
#leftJoystick{left:4vw;bottom:4vh;}
#rightJoystick{right:4vw;bottom:4vh;}
#jumpButton{position:absolute;width:clamp(56px,9vw,90px);height:clamp(56px,9vw,90px);border-radius:50%;background:rgba(255,40,40,0.85);right:4vw;bottom:calc(4vh + clamp(72px,12vw,120px) + 8px);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;user-select:none;-webkit-user-select:none;touch-action:none;}
#hud{position:absolute;left:8px;top:8px;color:#fff;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial; font-weight:700;text-shadow:0 1px 3px rgba(0,0,0,0.6);pointer-events:none;}
.spawnButtons{position:absolute;right:4vw;top:6vh;display:flex;flex-direction:column;gap:8px;}
.spawnBtn{min-width:84px;padding:8px 12px;border-radius:10px;background:rgba(0,0,0,0.45);color:#fff;font-weight:700;text-align:center;touch-action:none;-webkit-user-select:none;}
#credits{position:absolute;left:8px;bottom:8px;color:rgba(255,255,255,0.8);font-size:12px;pointer-events:none;}
</style>
</head>
<body>
<canvas id="renderCanvas"></canvas>
<div id="leftJoystick" class="joystick"><div class="joystick-inner"></div></div>
<div id="rightJoystick" class="joystick"><div class="joystick-inner"></div></div>
<div id="jumpButton">JUMP</div>
<div class="spawnButtons">
<div id="spawnGren" class="spawnBtn">Grenade</div>
<div id="spawnBlock" class="spawnBtn">Block</div>
<div id="clearBtn" class="spawnBtn">Clear</div>
</div>
<div id="hud"></div>
<div id="credits">Physics Playground â€¢ loud russian mode</div>
<audio id="bgm" src="shorts.mp3" loop autoplay></audio>
<script src="https://cdn.babylonjs.com/babylon.js"></script>
<script src="https://cdn.babylonjs.com/gui/babylon.gui.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js"></script>
<script>
const canvas=document.getElementById('renderCanvas');
const engine=new BABYLON.Engine(canvas,true,{preserveDrawingBuffer:true,stencil:true});
const scene=new BABYLON.Scene(engine);
scene.clearColor=new BABYLON.Color3(0.06,0.06,0.07);
const gravity = new BABYLON.Vector3(0,-9.81,0);
const cannonPlugin = new BABYLON.CannonJSPlugin(true, undefined, CANNON);
scene.enablePhysics(gravity, cannonPlugin);
const camera=new BABYLON.UniversalCamera('cam', new BABYLON.Vector3(0,2,0), scene);
camera.attachControl(canvas,true);
camera.applyGravity=true;
camera.checkCollisions=true;
camera.ellipsoid=new BABYLON.Vector3(0.5,1,0.5);
const light=new BABYLON.HemisphericLight('h', new BABYLON.Vector3(0.5,1,0.25), scene);
light.intensity=0.9;

const ground=BABYLON.MeshBuilder.CreateGround('ground',{width:120, height:120}, scene);
ground.position.y=0;
ground.checkCollisions=true;
ground.receiveShadows=true;
ground.physicsImpostor=new BABYLON.PhysicsImpostor(ground,BABYLON.PhysicsImpostor.BoxImpostor,{mass:0,friction:1,restitution:0.1},scene);

const matGround=new BABYLON.StandardMaterial('gmat',scene);
matGround.diffuseColor=new BABYLON.Color3(0.18,0.18,0.2);
ground.material=matGround;

function createWall(name,w,h,d,x,y,z,rotY){
 const m=BABYLON.MeshBuilder.CreateBox(name,{width:w,height:h,depth:d},scene);
 m.position.set(x,y,z);
 if(rotY) m.rotation.y=rotY;
 m.checkCollisions=true;
 m.physicsImpostor=new BABYLON.PhysicsImpostor(m,BABYLON.PhysicsImpostor.BoxImpostor,{mass:0,friction:1,restitution:0.01},scene);
 const mm=new BABYLON.StandardMaterial(name+'mat',scene);
 mm.diffuseColor=new BABYLON.Color3(0.28,0.26,0.24);
 m.material=mm;
 return m;
}

createWall('wallN',80,6,1,0,3, -60);
createWall('wallS',80,6,1,0,3, 60);
createWall('wallE',1,6,60,60,3,0);
createWall('wallW',1,6,60,-60,3,0);

const ramp=BABYLON.MeshBuilder.CreateBox('r',{width:12,height:1.2,depth:12},scene);
ramp.position.set(-18,0.6,18);
ramp.rotation.z= -0.35;
ramp.physicsImpostor=new BABYLON.PhysicsImpostor(ramp,BABYLON.PhysicsImpostor.BoxImpostor,{mass:0,friction:1,restitution:0.1},scene);
ramp.material=new BABYLON.StandardMaterial('rmat',scene);
ramp.material.diffuseColor=new BABYLON.Color3(0.22,0.2,0.18);

const crateParent=new BABYLON.TransformNode('crates',scene);
for(let i=0;i<12;i++){
 const b=BABYLON.MeshBuilder.CreateBox('box'+i,{size:2},scene);
 b.position.set(-10 + (i%4)*2.4,1 + Math.floor(i/4)*2.1, -8 + Math.floor(i/4)*3.2);
 b.physicsImpostor=new BABYLON.PhysicsImpostor(b,BABYLON.PhysicsImpostor.BoxImpostor,{mass:3,friction:0.8,restitution:0.05},scene);
 b.checkCollisions=true;
 b.material=new BABYLON.StandardMaterial('bm'+i,scene);
 b.material.diffuseColor=new BABYLON.Color3(Math.random()*0.6+0.2,Math.random()*0.6+0.2,Math.random()*0.6+0.2);
 b.parent=crateParent;
}

const pillar=BABYLON.MeshBuilder.CreateCylinder('p',{diameter:3,height:8, tessellation:24},scene);
pillar.position.set(18,4, -18);
pillar.physicsImpostor=new BABYLON.PhysicsImpostor(pillar,BABYLON.PhysicsImpostor.CylinderImpostor,{mass:0,friction:1,restitution:0.05},scene);
pillar.material=new BABYLON.StandardMaterial('pm',scene);
pillar.material.diffuseColor=new BABYLON.Color3(0.26,0.26,0.28);

let moveForward=0, moveRight=0, lookX=0, lookY=0;
let verticalVelocity=0;
const GRAV=-0.035;
const JUMP_SPEED=0.55;
const left=document.getElementById('leftJoystick');
const right=document.getElementById('rightJoystick');
const jumpBtn=document.getElementById('jumpButton');
const hud=document.getElementById('hud');

function setupJoystick(joystick,cb){
 let active=false, sx=0, sy=0;
 const inner=joystick.querySelector('.joystick-inner');
 joystick.addEventListener('touchstart', e=>{
   e.preventDefault();
   active=true;
   const t=e.touches[0];
   sx=t.clientX; sy=t.clientY;
 },{passive:false});
 joystick.addEventListener('touchmove', e=>{
   e.preventDefault();
   if(!active) return;
   const t=e.touches[0];
   const dx=t.clientX-sx, dy=t.clientY-sy;
   inner.style.transform=`translate(${dx/2}px,${dy/2}px)`;
   cb(dx/50,dy/50);
 },{passive:false});
 joystick.addEventListener('touchend', e=>{
   e.preventDefault();
   active=false;
   inner.style.transform='translate(0px,0px)';
   cb(0,0);
 },{passive:false});
}

setupJoystick(left,(x,y)=>{ moveRight = x; moveForward = -y; });
setupJoystick(right,(x,y)=>{ lookX = x*1.6; lookY = y*1.6; });

let jumpPressed=false;
jumpBtn.addEventListener('touchstart', e=>{ e.preventDefault(); jumpPressed=true; },{passive:false});
jumpBtn.addEventListener('touchend', e=>{ e.preventDefault(); jumpPressed=false; },{passive:false});

function isGrounded(){
 const origin = camera.position.clone();
 const down = origin.clone().add(new BABYLON.Vector3(0,-1.25,0));
 const r = new BABYLON.Ray(origin, down.subtract(origin).normalize(), 1.4);
 const hit = scene.pickWithRay(r, (m)=>{ return m!==camera; });
 if(hit && hit.hit) return {hit:true,point:hit.pickedPoint};
 return {hit:false};
}

scene.onBeforeRenderObservable.add(()=>{
 camera.rotation.y += lookX*0.02;
 camera.rotation.x += lookY*0.02;
 if(camera.rotation.x>Math.PI/2) camera.rotation.x=Math.PI/2;
 if(camera.rotation.x<-Math.PI/2) camera.rotation.x=-Math.PI/2;
 const forwardVec = new BABYLON.Vector3(Math.sin(camera.rotation.y),0,Math.cos(camera.rotation.y));
 const rightVec = new BABYLON.Vector3(Math.sin(camera.rotation.y+Math.PI/2),0,Math.cos(camera.rotation.y+Math.PI/2));
 camera.position.addInPlace(forwardVec.scale(moveForward*0.2));
 camera.position.addInPlace(rightVec.scale(moveRight*0.2));
 const g = isGrounded();
 if(g.hit && verticalVelocity<=0){
   verticalVelocity = 0;
   camera.position.y = g.point.y + camera.ellipsoid.y;
   if(jumpPressed){ verticalVelocity = JUMP_SPEED; }
 } else {
   if(jumpPressed && verticalVelocity>0.001){} 
   verticalVelocity += GRAV;
   camera.position.y += verticalVelocity;
 }
});

engine.runRenderLoop(()=>{ scene.render(); hud.innerText = Math.round(engine.getFps()) + " FPS"; });

window.addEventListener('resize', ()=>{ engine.resize(); });

const spawnGren=document.getElementById('spawnGren');
const spawnBlock=document.getElementById('spawnBlock');
const clearBtn=document.getElementById('clearBtn');
const spawned=[];

function spawnBlockAt(pos, size=1.6){
 const b=BABYLON.MeshBuilder.CreateBox('spawnB'+Date.now(),{size:size},scene);
 b.position.copyFrom(pos);
 b.position.y += 1.2;
 b.physicsImpostor=new BABYLON.PhysicsImpostor(b,BABYLON.PhysicsImpostor.BoxImpostor,{mass:2,friction:0.8,restitution:0.05},scene);
 b.material=new BABYLON.StandardMaterial('smat',scene);
 b.material.diffuseColor=new BABYLON.Color3(Math.random(),Math.random(),Math.random());
 spawned.push(b);
 return b;
}

function spawnGrenade(){
 const s=BABYLON.MeshBuilder.CreateSphere('gren'+Date.now(),{diameter:0.9,segments:12},scene);
 s.position = camera.position.clone();
 const forward = new BABYLON.Vector3(Math.sin(camera.rotation.y), Math.sin(-camera.rotation.x)*0.2, Math.cos(camera.rotation.y));
 s.position.addInPlace(forward.scale(1.6));
 s.physicsImpostor=new BABYLON.PhysicsImpostor(s,BABYLON.PhysicsImpostor.SphereImpostor,{mass:1,friction:0.4,restitution:0.2},scene);
 const mat=new BABYLON.StandardMaterial('gmat',scene); mat.emissiveColor=new BABYLON.Color3(0.9,0.25,0.1);
 s.material=mat;
 const impulse = forward.scale(10);
 s.physicsImpostor.applyImpulse(impulse, s.getAbsolutePosition());
 spawned.push(s);
 setTimeout(()=>{ explodeAt(s.getAbsolutePosition()); if(!s.isDisposed()) s.dispose(); },1200);
}

function explodeAt(center){
 const radius=8;
 const all=scene.meshes;
 for(let i=0;i<all.length;i++){
   const m=all[i];
   if(m.physicsImpostor && m.physicsImpostor.getParam) {
     const pos = m.getAbsolutePosition();
     const to = pos.subtract(center);
     const dist = Math.max(0.0001, to.length());
     if(dist < radius && m.physicsImpostor.getMass && m.physicsImpostor.getMass() > 0){
       const forceMag = 180 / (dist*dist);
       const impulse = to.normalize().scale(forceMag);
       m.physicsImpostor.applyImpulse(impulse, pos);
     }
   } else if(m.physicsImpostor){
     const pos = m.getAbsolutePosition();
     const to = pos.subtract(center);
     const dist = Math.max(0.0001, to.length());
     if(dist < radius){
       const forceMag = 180 / (dist*dist);
       const impulse = to.normalize().scale(forceMag);
       try{ m.physicsImpostor.applyImpulse(impulse, pos);}catch(e){}
     }
   }
 }
}

spawnBlock.addEventListener('touchstart', e=>{ e.preventDefault(); const dir=new BABYLON.Vector3(Math.sin(camera.rotation.y), -Math.sin(camera.rotation.x)*0.2, Math.cos(camera.rotation.y)); const pos=camera.position.clone().add(dir.scale(2.2)); spawnBlockAt(pos,1.8); },{passive:false});
spawnGren.addEventListener('touchstart', e=>{ e.preventDefault(); spawnGrenade(); },{passive:false});
clearBtn.addEventListener('touchstart', e=>{ e.preventDefault(); for(const s of spawned){ if(s && !s.isDisposed()) s.dispose(); } spawned.length=0; },{passive:false});

const music=document.getElementById('bgm');
music.volume=0.95;
music.play().catch(()=>{});

</script>
</body>
</html>
