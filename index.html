<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0, user-scalable=no">
<title>Sandbox Destruct V2</title>
<style>
html,body{width:100%;height:100%;margin:0;overflow:hidden;touch-action:none;-webkit-user-select:none;-ms-touch-action:none}
canvas{width:100%;height:100%;display:block}
#fps{position:fixed;left:50%;transform:translateX(-50%);top:2vmin;background:rgba(0,0,0,0.5);padding:6px 10px;border-radius:8px;color:#fff;font-family:monospace;z-index:60;font-size:12px}
.button{background:rgba(30,30,30,0.7);color:#fff;padding:8px 12px;border-radius:8px;font-family:system-ui;font-weight:600;user-select:none;-webkit-user-select:none;touch-action:none}
#spawnMenu{position:fixed;right:8px;top:8px;z-index:50;display:flex;flex-direction:column;gap:8px}
#spawnGrid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
#leftJoystick{position:fixed;left:3vmin;bottom:3vmin;width:12vmin;height:12vmin;border-radius:50%;background:rgba(0,0,0,0.28);display:flex;align-items:center;justify-content:center;z-index:40;touch-action:none}
.left-inner{width:6vmin;height:6vmin;border-radius:50%;background:rgba(0,0,0,0.5);transform:translate(0,0)}
#cameraJoystick{position:fixed;right:3vmin;bottom:3vmin;width:12vmin;height:12vmin;border-radius:50%;background:rgba(0,0,0,0.28);display:flex;align-items:center;justify-content:center;z-index:40;touch-action:none}
.camera-inner{width:6vmin;height:6vmin;border-radius:50%;background:rgba(0,0,0,0.5);transform:translate(0,0)}
#jumpBtn{position:fixed;right:3vmin;bottom:16vmin;width:9vmin;height:9vmin;border-radius:50%;background:rgba(220,20,60,0.9);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;z-index:40;touch-action:none}
#throwBtn{position:fixed;left:50%;transform:translateX(-50%);bottom:3vmin;width:28vmin;height:9vmin;border-radius:10px;background:rgba(25,125,255,0.9);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;z-index:40;touch-action:none}
#autoBtn{position:fixed;left:calc(50% + 32vmin);bottom:3vmin;width:14vmin;height:9vmin;border-radius:10px;background:rgba(255,90,20,0.9);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;z-index:40;touch-action:none}
#menuBtn{position:fixed;left:8px;top:50%;transform:translateY(-50%);width:50px;height:50px;border-radius:50%;background:rgba(50,50,50,0.8);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;z-index:55;touch-action:none}
</style>
</head>
<body>
<canvas id="renderCanvas"></canvas>
<div id="fps">FPS: 0</div>
<div id="menuBtn">M</div>
<div id="spawnMenu">
<div id="spawnGrid">
<button class="button" data-item="box">Box</button>
<button class="button" data-item="sphere">Sphere</button>
<button class="button" data-item="rock">Rock</button>
<button class="button" data-item="ramp">Ramp</button>
<button class="button" data-item="wall">Wall</button>
<button class="button" data-item="barrel">Explosive Barrel</button>
<button class="button" data-item="grenade">Grenade</button>
<button class="button" data-item="fan">Fan</button>
<button class="button" data-item="spike">Spike</button>
<button class="button" data-item="crate">Crate</button>
</div>
</div>
<div id="leftJoystick"><div class="left-inner"></div></div>
<div id="cameraJoystick"><div class="camera-inner"></div></div>
<div id="jumpBtn">JUMP</div>
<div id="throwBtn">THROW</div>
<div id="autoBtn">FULL AUTO</div>
<audio id="bgMusic" src="loud russian music shorts.mp3" loop autoplay></audio>
<script src="https://cdn.jsdelivr.net/npm/cannon@0.6.2/build/cannon.min.js"></script>
<script src="https://cdn.babylonjs.com/babylon.js"></script>
<script>
const canvas=document.getElementById("renderCanvas");
const engine=new BABYLON.Engine(canvas,true,{preserveDrawingBuffer:true,stencil:true});
const scene=new BABYLON.Scene(engine);
scene.clearColor=new BABYLON.Color3(0.75,0.9,1);
const gravity=new BABYLON.Vector3(0,-9.81,0);
const plugin=new BABYLON.CannonJSPlugin(true,undefined,CANNON);
scene.enablePhysics(gravity,plugin);
scene.collisionsEnabled=true;
const hemi=new BABYLON.HemisphericLight("h", new BABYLON.Vector3(0.2,1,0.1), scene);
hemi.intensity=0.9;
const dir=new BABYLON.DirectionalLight("d", new BABYLON.Vector3(-0.5,-1,-0.3), scene);
dir.position=new BABYLON.Vector3(0,40,0);
dir.intensity=1.1;
const shadowGen=new BABYLON.ShadowGenerator(1024, dir);
shadowGen.useBlurExponentialShadowMap=true;
const groundMat=new BABYLON.StandardMaterial("gm",scene);
groundMat.diffuseColor=new BABYLON.Color3(0.18,0.5,0.18);
const ground=BABYLON.MeshBuilder.CreateGround("ground",{width:120,height:120},scene);
ground.position.y=0;
ground.material=groundMat;
ground.receiveShadows=true;
ground.physicsImpostor=new BABYLON.PhysicsImpostor(ground,BABYLON.PhysicsImpostor.BoxImpostor,{mass:0,friction:1,restitution:0},scene);
const arenaWalls=[];
function makeWall(w,h,d,x,y,z,rotY){
  const m=BABYLON.MeshBuilder.CreateBox("wall"+arenaWalls.length,{width:w,height:h,depth:d},scene);
  m.position.set(x,y,z); m.rotation.y=rotY||0;
  m.checkCollisions=true;
  m.material=new BABYLON.StandardMaterial("wm"+arenaWalls.length,scene);
  m.material.diffuseColor=new BABYLON.Color3(0.6,0.55,0.5);
  m.physicsImpostor=new BABYLON.PhysicsImpostor(m,BABYLON.PhysicsImpostor.BoxImpostor,{mass:0,friction:1,restitution:0},scene);
  arenaWalls.push(m); return m;
}
makeWall(120,8,1,0,4,60,0);
makeWall(120,8,1,0,4,-60,0);
makeWall(1,8,120,60,4,0,0);
makeWall(1,8,120,-60,4,0,0);
const platform=BABYLON.MeshBuilder.CreateBox("platform",{width:16,height:1,depth:16},scene);
platform.position.set(-22,1.5,-12);
platform.material=new BABYLON.StandardMaterial("pMat",scene);
platform.material.diffuseColor=new BABYLON.Color3(0.5,0.4,0.7);
platform.physicsImpostor=new BABYLON.PhysicsImpostor(platform,BABYLON.PhysicsImpostor.BoxImpostor,{mass:0,friction:1},scene);
shadowGen.addShadowCaster(platform);
const destructibles=[];
function makeDestructibleBox(x,y,z,size){
  const b=BABYLON.MeshBuilder.CreateBox("dBox"+destructibles.length,{size:size},scene);
  b.position.set(x,y,z);
  b.material=new BABYLON.StandardMaterial("dbMat"+destructibles.length,scene);
  b.material.diffuseColor=new BABYLON.Color3(Math.random()*0.6+0.2,Math.random()*0.6+0.2,Math.random()*0.6+0.2);
  b.physicsImpostor=new BABYLON.PhysicsImpostor(b,BABYLON.PhysicsImpostor.BoxImpostor,{mass:3,friction:0.6,restitution:0.1},scene);
  destructibles.push(b);
  shadowGen.addShadowCaster(b);
  return b;
}
for(let i=0;i<18;i++){ makeDestructibleBox(-10+Math.random()*20,2,-10+Math.random()*20,2);}
const playerVis=BABYLON.MeshBuilder.CreateBox("playerVis",{width:1.2,height:2,depth:1},scene);
playerVis.position=new BABYLON.Vector3(0,2,8);
playerVis.material=new BABYLON.StandardMaterial("pvMat",scene);
playerVis.material.diffuseColor=new BABYLON.Color3(0.2,0.6,1);
playerVis.isVisible=true;
playerVis.checkCollisions=true;
playerVis.ellipsoid=new BABYLON.Vector3(0.6,1,0.6);
playerVis.ellipsoidOffset=new BABYLON.Vector3(0,1,0);
const playerPhysics=new BABYLON.PhysicsImpostor(playerVis,BABYLON.PhysicsImpostor.BoxImpostor,{mass:1,friction:0.2,restitution:0},scene);
playerPhysics.sleep(false);
const camPivot=new BABYLON.TransformNode("camPivot",scene);
camPivot.parent=playerVis;
const camera=new BABYLON.UniversalCamera("cam",new BABYLON.Vector3(0,1.2,0),scene);
camera.parent=camPivot;
camera.minZ=0.1;
camera.position=new BABYLON.Vector3(0,1.2,0);
camera.attachControl(canvas,true);
let moveForward=0,moveRight=0,jump=false,camYaw=0,camPitch=0;
const leftJoy=document.getElementById("leftJoystick");
const leftInner=leftJoy.querySelector(".left-inner");
const camJoy=document.getElementById("cameraJoystick");
const camInner=camJoy.querySelector(".camera-inner");
const jumpBtn=document.getElementById("jumpBtn");
const throwBtn=document.getElementById("throwBtn");
const autoBtn=document.getElementById("autoBtn");
const menuBtn=document.getElementById("menuBtn");
let autoInterval=null;
let leftId=null,camId=null;

function setupJoystick(joy,inner,updateX,updateY){
  let active=false,startX=0,startY=0;
  let valX=0,valY=0;
  joy.addEventListener("touchstart",e=>{ e.preventDefault(); const t=e.changedTouches[0]; active=true; startX=t.clientX; startY=t.clientY; if(joy===leftJoy) leftId=t.identifier; else camId=t.identifier; });
  joy.addEventListener("touchmove",e=>{ e.preventDefault(); for(const t of e.changedTouches){ if((joy===leftJoy&&t.identifier!==leftId)||(joy===camJoy&&t.identifier!==camId)) continue; valX=(t.clientX-startX)/50; valY=(t.clientY-startY)/50; valX=Math.max(-1,Math.min(1,valX)); valY=Math.max(-1,Math.min(1,valY)); inner.style.transform=`translate(${(t.clientX-startX)/3}px,${(t.clientY-startY)/3}px)`; updateX(valX); updateY(valY); } });
  joy.addEventListener("touchend",e=>{ e.preventDefault(); for(const t of e.changedTouches){ if((joy===leftJoy&&t.identifier!==leftId)||(joy===camJoy&&t.identifier!==camId)) continue; inner.style.transform='translate(0,0)'; updateX(0); updateY(0); active=false; leftId=null; camId=null;} });
  joy.addEventListener("touchcancel",e=>{ e.preventDefault(); inner.style.transform='translate(0,0)'; updateX(0); updateY(0); active=false; leftId=null; camId=null; });
}
setupJoystick(leftJoy,leftInner,(x)=>{moveRight=x;},(y)=>{moveForward=-y;});
setupJoystick(camJoy,camInner,(x)=>{camYaw=x;},(y)=>{camPitch=-y;});

jumpBtn.addEventListener("touchstart",e=>{ e.preventDefault(); if(isGrounded()){ playerPhysics.applyImpulse(new BABYLON.Vector3(0,6,0), playerVis.getAbsolutePosition()); } },{passive:false});
throwBtn.addEventListener("touchstart",e=>{ e.preventDefault(); throwRock(); },{passive:false});
autoBtn.addEventListener("touchstart",e=>{ e.preventDefault(); if(autoInterval) return; autoInterval=setInterval(()=>{ fireBullet(); },90); },{passive:false});
autoBtn.addEventListener("touchend",e=>{ e.preventDefault(); if(autoInterval){ clearInterval(autoInterval); autoInterval=null; } },{passive:false});
menuBtn.addEventListener("click",()=>{ spawnMenu.style.display=spawnMenu.style.display==="none"?"flex":"none"; });

function isGrounded(){ const origin=playerVis.position.clone(); const ray=new BABYLON.Ray(origin,new BABYLON.Vector3(0,-1,0),1.05); const pick=scene.pickWithRay(ray,m=> m!==playerVis); return pick&&pick.hit;}
function forwardVector(){ const y=playerVis.rotation.y+camYaw; return new BABYLON.Vector3(Math.sin(y),0,Math.cos(y));}

function throwRock(){
  const f=forwardVector();
  const rock=BABYLON.MeshBuilder.CreateSphere("rock"+Math.random(),{diameter:0.6},scene);
  rock.position=playerVis.position.add(new BABYLON.Vector3(0,1.2,0)).add(f.scale(1.2));
  rock.material=new BABYLON.StandardMaterial("rMat",scene);
  rock.material.diffuseColor=new BABYLON.Color3(0.45,0.45,0.45);
  rock.physicsImpostor=new BABYLON.PhysicsImpostor(rock,BABYLON.PhysicsImpostor.SphereImpostor,{mass:1,friction:0.2,restitution:0.2},scene);
  rock.physicsImpostor.applyImpulse(f.scale(16).add(new BABYLON.Vector3(0,4,0)), rock.getAbsolutePosition());
  setTimeout(()=>{ try{ rock.dispose(); }catch(e){} },9000);
  setupImpact(rock);
}
function fireBullet(){
  const f=forwardVector();
  const b=BABYLON.MeshBuilder.CreateSphere("bullet"+Math.random(),{diameter:0.35},scene);
  b.position=playerVis.position.add(new BABYLON.Vector3(0,1.2,0)).add(f.scale(1.2));
  b.material=new BABYLON.StandardMaterial("bm",scene);
  b.material.diffuseColor=new BABYLON.Color3(0.9,0.85,0.6);
  b.physicsImpostor=new BABYLON.PhysicsImpostor(b,BABYLON.PhysicsImpostor.SphereImpostor,{mass:0.1,friction:0.1,restitution:0.05},scene);
  b.physicsImpostor.applyImpulse(f.scale(80), b.getAbsolutePosition());
  setTimeout(()=>{ try{ b.dispose(); }catch(e){} },3000);
  setupImpact(b);
}

function setupImpact(mesh){
  mesh.physicsImpostor.registerOnPhysicsCollide(destructibles.map(d=>d.physicsImpostor),(main,other)=>{
    const impact=main.getLinearVelocity().length();
    const targetMesh=other.object;
    if(targetMesh&&!targetMesh._destroyed){
      if(targetMesh.metadata&&targetMesh.metadata.type==="barrel"&&impact>6) explodeAt(targetMesh.position,targetMesh);
      else if(impact>10||Math.random()>0.985) destroyMesh(targetMesh);
    }
  });
}

function destroyMesh(m){
  if(!m||m._destroyed) return; m._destroyed=true;
  const p=m.position.clone();
  const efx=BABYLON.MeshBuilder.CreateSphere("ef"+Math.random(),{diameter:0.4},scene);
  efx.position.copyFrom(p);
  efx.material=new BABYLON.StandardMaterial("efm",scene);
  efx.material.emissiveColor=new BABYLON.Color3(1,0.5,0.15);
  setTimeout(()=>{ try{ efx.dispose(); }catch(e){} },600);
  try{ if(m.physicsImpostor) m.physicsImpostor.dispose(); }catch(e){}
  setTimeout(()=>{ try{ m.dispose(); }catch(e){} },40);
}
function explodeAt(pos,source){
  const radius=10;
  const strength=180;
  for(const m of scene.meshes){
    if(!m.physicsImpostor) continue;
    const dist=BABYLON.Vector3.Distance(m.position,pos);
    if(dist>radius) continue;
    const dir=m.position.subtract(pos).normalize();
    const force=dir.scale((1-(dist/radius))*strength);
    m.physicsImpostor.applyImpulse(force,m.getAbsolutePosition());
    if(m!==source&&Math.random()<0.5) destroyMesh(m);
  }
  const explosion=BABYLON.MeshBuilder.CreateSphere("exp"+Math.random(),{diameter:2},scene);
  explosion.position.copyFrom(pos);
  const mat=new BABYLON.StandardMaterial("em",scene);
  mat.emissiveColor=new BABYLON.Color3(1,0.3,0);
  explosion.material=mat;
  setTimeout(()=>{ try{ explosion.dispose(); }catch(e){} },400);
}
const randomItems=["cone","tube","pyramid"];
document.querySelectorAll("#spawnGrid button").forEach(b=>{
  b.addEventListener("click",()=>{
    let type=b.dataset.item;
    if(type==="random"){ type=randomItems[Math.floor(Math.random()*randomItems.length)]; }
    spawnItem(type);
  });
});

function spawnItem(type){
  let m;
  switch(type){
    case"box": m=BABYLON.MeshBuilder.CreateBox("box",{size:2},scene); break;
    case"sphere": m=BABYLON.MeshBuilder.CreateSphere("sphere",{diameter:2},scene); break;
    case"rock": m=BABYLON.MeshBuilder.CreateSphere("rock",{diameter:1.5},scene); break;
    case"ramp": m=BABYLON.MeshBuilder.CreateBox("ramp",{width:2,height:0.5,depth:3},scene); break;
    case"wall": m=BABYLON.MeshBuilder.CreateBox("wall",{width:3,height:4,depth:0.5},scene); break;
    case"barrel": m=BABYLON.MeshBuilder.CreateCylinder("barrel",{diameter:1.5,height:2},scene); m.metadata={type:"barrel"}; break;
    case"grenade": m=BABYLON.MeshBuilder.CreateSphere("gren",{diameter:1},scene); m.material=new BABYLON.StandardMaterial("gmat",scene); m.material.diffuseColor=new BABYLON.Color3(0.1,0.9,0.1); m.metadata={type:"grenade"}; break;
    case"fan": m=BABYLON.MeshBuilder.CreateCylinder("fan",{diameter:0.5,height:0.2},scene); break;
    case"spike": m=BABYLON.MeshBuilder.CreateCylinder("spike",{diameter:0.5,height:1},scene); break;
    case"crate": m=BABYLON.MeshBuilder.CreateBox("crate",{size:2},scene); break;
    case"cone": m=BABYLON.MeshBuilder.CreateCylinder("cone",{diameterTop:0,diameterBottom:1.5,height:2},scene); break;
    case"tube": m=BABYLON.MeshBuilder.CreateCylinder("tube",{diameter:1,height:3},scene); break;
    case"pyramid": m=BABYLON.MeshBuilder.CreateCylinder("pyr",{diameterTop:0,diameterBottom:2,height:2},scene); break;
  }
  if(!m) return;
  m.position=playerVis.position.add(new BABYLON.Vector3(0,2,0)).add(forwardVector().scale(2));
  m.physicsImpostor=new BABYLON.PhysicsImpostor(m,BABYLON.PhysicsImpostor.BoxImpostor,{mass:2,friction:0.5,restitution:0.2},scene);
  shadowGen.addShadowCaster(m);
}
engine.runRenderLoop(()=>{
  const dt=engine.getDeltaTime()/1000;
  const fwd=forwardVector().scale(moveForward*8);
  const right=new BABYLON.Vector3(Math.cos(playerVis.rotation.y),0,-Math.sin(playerVis.rotation.y)).scale(moveRight*8);
  const vel=fwd.add(right); vel.y=playerPhysics.getLinearVelocity().y;
  playerPhysics.setLinearVelocity(vel);
  camPivot.rotation.x=Math.max(-Math.PI/3,Math.min(Math.PI/3,camPivot.rotation.x+camPitch*dt*2));
  playerVis.rotation.y+=camYaw*dt*2;
  camPitch=0; camYaw=0;
  document.getElementById("fps").innerText="FPS: "+Math.round(engine.getFps());
});
window.addEventListener("resize",()=>{engine.resize();});
</script>
</body>
</html>
