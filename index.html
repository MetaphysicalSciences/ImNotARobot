<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1, minimum-scale=1">
<title>Snake XP Edition</title>
<style>
html,body{margin:0;padding:0;overflow:hidden;font-family:"Tahoma","Verdana",sans-serif;background:#008080;touch-action:none;-webkit-user-select:none;}
canvas{display:block;background:#0a0a0a;}
#joystick{position:absolute;bottom:50px;left:50px;width:100px;height:100px;border-radius:50%;background:rgba(255,255,255,0.2);touch-action:none;}
#stick{position:absolute;top:35px;left:35px;width:30px;height:30px;border-radius:50%;background:rgba(255,255,255,0.5);}
#menu,#lose,#settings{position:absolute;top:0;left:0;width:100%;height:100%;background:#c0c0c0;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:10;}
button{margin:10px;padding:10px 20px;background:#e0e0e0;border:2px solid #808080;font-size:16px;cursor:pointer;}
input[type=range]{width:150px;margin:10px;}
select{margin:10px;}
#score{position:absolute;top:10px;left:10px;color:#fff;font-size:24px;text-shadow:1px 1px #000;}
</style>
</head>
<body>
<canvas id="game"></canvas>
<div id="joystick"><div id="stick"></div></div>
<div id="score">Score: 0</div>
<div id="menu">
<h1>Snake XP Edition</h1>
<button id="startBtn">Start Game</button>
<button id="settingsBtn">Settings</button>
</div>
<div id="lose" style="display:none;">
<h1>You Lost!</h1>
<p id="finalScore">Score: 0</p>
<button id="retryBtn">Retry</button>
</div>
<div id="settings" style="display:none;">
<h2>Settings</h2>
<label>Joystick Size <input type="range" id="joySize" min="50" max="200" value="100"></label>
<label>Snake Color <input type="color" id="snakeColor" value="#0f0"></label>
<label>Snake Shape
<select id="snakeShape">
<option value="rect">Rectangle</option>
<option value="circle">Circle</option>
<option value="triangle">Triangle</option>
</select>
</label>
<label>Snake Speed <input type="range" id="snakeSpeed" min="1" max="10" value="4"></label>
<label>Tail Growth <input type="range" id="tailGrowth" min="1" max="10" value="2"></label>
<label>Background Color <input type="color" id="bgColor" value="#0a0a0a"></label>
<label>Fruit Spawn Rate <input type="range" id="fruitRate" min="1" max="20" value="5"></label>
<button id="backBtn">Back</button>
</div>
<script>
const canvas=document.getElementById('game');
const ctx=canvas.getContext('2d');
let w=canvas.width=window.innerWidth;
let h=canvas.height=window.innerHeight;
window.addEventListener('resize',()=>{w=canvas.width=window.innerWidth;h=canvas.height=window.innerHeight;});

let snake=[],dir={x:1,y:0},speed=4,score=0,health=10,frame=0,snakeColor="#0f0",snakeShape="rect";
let joystick=document.getElementById('joystick');
let stick=document.getElementById('stick');
let active=false,startX=0,startY=0;
let menu=document.getElementById('menu'),loseScreen=document.getElementById('lose'),settingsScreen=document.getElementById('settings');
let fruits=[],bgColor="#0a0a0a",tailGrowth=2,fruitRate=5;

function resetGame(){
    snake=[{x:w/2,y:h/2}];
    dir={x:1,y:0};
    speed=parseInt(document.getElementById('snakeSpeed').value);
    score=0;
    health=10;
    fruits=[];
    spawnFruit();
}

function spawnFruit(){
    if(Math.random()*20<fruitRate){
        let type=Math.random()<0.05?3:(Math.random()<0.15?2:1);
        let f={x:Math.random()*(w-20)+10,y:Math.random()*(h-20)+10,type:type};
        fruits.push(f);
    }
}

function drawSnake(){
    for(let s of snake){
        ctx.fillStyle=snakeColor;
        if(snakeShape==="rect") ctx.fillRect(s.x-10,s.y-10,20,20);
        else if(snakeShape==="circle"){ctx.beginPath();ctx.arc(s.x,s.y,10,0,Math.PI*2);ctx.fill();}
        else if(snakeShape==="triangle"){ctx.beginPath();ctx.moveTo(s.x,s.y-10);ctx.lineTo(s.x-10,s.y+10);ctx.lineTo(s.x+10,s.y+10);ctx.closePath();ctx.fill();}
    }
}

function drawFruits(){
    for(let f of fruits){
        if(f.type===1) ctx.fillStyle="#f00";
        else if(f.type===2) ctx.fillStyle="#ff0";
        else ctx.fillStyle="#0ff";
        ctx.beginPath();
        ctx.arc(f.x,f.y,10,0,Math.PI*2);
        ctx.fill();
    }
}

function checkCollision(){
    let head=snake[0];
    for(let i=1;i<snake.length;i++){
        let s=snake[i];
        if(Math.hypot(s.x-head.x,s.y-head.y)<15){
            health-=2;
            if(health<=0){lose();return;}
        }
    }
    for(let i=fruits.length-1;i>=0;i--){
        let f=fruits[i];
        if(Math.hypot(f.x-head.x,f.y-head.y)<15){
            if(f.type===1){for(let j=0;j<tailGrowth;j++) snake.push({...snake[snake.length-1]});score+=10;}
            else if(f.type===2){for(let j=0;j<tailGrowth*2;j++) snake.push({...snake[snake.length-1]});score+=30;}
            else {for(let j=0;j<tailGrowth*4;j++) snake.push({...snake[snake.length-1]});score+=50;}
            fruits.splice(i,1);
            spawnFruit();
        }
    }
}

function moveSnake(){
    let head=snake[0];
    head={x:head.x+dir.x*speed,y:head.y+dir.y*speed};
    if(head.x<0) head.x=0;if(head.x>w) head.x=w;
    if(head.y<0) head.y=0;if(head.y>h) head.y=h;
    snake.unshift(head);
    snake.pop();
}

function gameLoop(){
    if(menu.style.display!=="none"||settingsScreen.style.display!=="none"||loseScreen.style.display!=="none") return;
    requestAnimationFrame(gameLoop);
    frame++;
    ctx.fillStyle=bgColor;
    ctx.fillRect(0,0,w,h);
    moveSnake();
    checkCollision();
    drawSnake();
    drawFruits();
    document.getElementById('score').innerText="Score: "+score;
    spawnFruit();
}

function lose(){
    loseScreen.style.display="flex";
    document.getElementById('finalScore').innerText="Score: "+score;
}

document.getElementById('startBtn').addEventListener('click',()=>{
    menu.style.display="none";
    resetGame();
    gameLoop();
});
document.getElementById('retryBtn').addEventListener('click',()=>{
    loseScreen.style.display="none";
    resetGame();
    gameLoop();
});
document.getElementById('settingsBtn').addEventListener('click',()=>{
    menu.style.display="none";
    settingsScreen.style.display="flex";
});
document.getElementById('backBtn').addEventListener('click',()=>{
    settingsScreen.style.display="none";
    menu.style.display="flex";
});

document.getElementById('joySize').addEventListener('input',e=>{
    joystick.style.width=e.target.value+'px';
    joystick.style.height=e.target.value+'px';
});
document.getElementById('snakeColor').addEventListener('input',e=>{snakeColor=e.target.value;});
document.getElementById('snakeShape').addEventListener('change',e=>{snakeShape=e.target.value;});
document.getElementById('snakeSpeed').addEventListener('input',e=>{speed=parseInt(e.target.value);});
document.getElementById('tailGrowth').addEventListener('input',e=>{tailGrowth=parseInt(e.target.value);});
document.getElementById('bgColor').addEventListener('input',e=>{bgColor=e.target.value;});
document.getElementById('fruitRate').addEventListener('input',e=>{fruitRate=parseInt(e.target.value);});

function limitDir(x,y){
    if(Math.abs(x)>Math.abs(y)){dir={x:x>0?1:-1,y:0};}
    else{dir={x:0,y:y>0?1:-1};}
}

joystick.addEventListener('touchstart',e=>{e.preventDefault();active=true;startX=e.touches[0].clientX;startY=e.touches[0].clientY;});
joystick.addEventListener('touchmove',e=>{
    if(!active) return;
    let tx=e.touches[0].clientX-startX;
    let ty=e.touches[0].clientY-startY;
    let dist=Math.min(parseInt(joystick.style.width)/2||50,Math.hypot(tx,ty));
    let angle=Math.atan2(ty,tx);
    stick.style.transform=`translate(${dist*Math.cos(angle)}px,${dist*Math.sin(angle)}px)`;
    limitDir(tx,ty);
});
joystick.addEventListener('touchend',e=>{active=false;stick.style.transform='translate(0,0)';});

document.addEventListener('gesturestart', e => e.preventDefault());
document.addEventListener('dblclick', e => e.preventDefault());
document.addEventListener('touchmove', e => {if(e.scale!==1)e.preventDefault();},{passive:false});
</script>
</body>
</html>
