<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1, minimum-scale=1">
<style>
html,body{margin:0;padding:0;overflow:hidden;background:#000;height:100%;touch-action:none;-webkit-user-select:none;-ms-touch-action:none;}
canvas{display:block;background:#111;}
#joystick{position:absolute;bottom:50px;left:50px;width:100px;height:100px;border-radius:50%;background:rgba(255,255,255,0.2);touch-action:none;}
#stick{position:absolute;top:35px;left:35px;width:30px;height:30px;border-radius:50%;background:rgba(255,255,255,0.5);}
#score{position:absolute;top:20px;left:50%;transform:translateX(-50%);color:#fff;font-size:24px;font-family:sans-serif;}
</style>
</head>
<body>
<canvas id="game"></canvas>
<div id="joystick"><div id="stick"></div></div>
<div id="score">Score: 0</div>
<script>
const canvas=document.getElementById('game');
const ctx=canvas.getContext('2d');
let w=canvas.width=window.innerWidth;
let h=canvas.height=window.innerHeight;
window.addEventListener('resize',()=>{w=canvas.width=window.innerWidth;h=canvas.height=window.innerHeight;});

const grid=20;
let snake=[{x:10,y:10,vx:1,vy:0}];
let dir={x:1,y:0};
let targetDir={x:1,y:0};
let fruits=[];
let score=0;
let speed=4;

function randFruit(){
    const type=Math.random();
    let value=1;
    if(type>0.95)value=5; // ultra rare
    else if(type>0.75)value=3; // rare
    fruits.push({
        x:Math.floor(Math.random()*w/grid),
        y:Math.floor(Math.random()*h/grid),
        value:value
    });
}

for(let i=0;i<3;i++)randFruit();

function resetGame(){
    snake=[{x:10,y:10,vx:1,vy:0}];
    dir={x:1,y:0};
    targetDir={x:1,y:0};
    fruits=[];
    score=0;
    for(let i=0;i<3;i++)randFruit();
}

let lastTime=0;
function gameLoop(t){
    requestAnimationFrame(gameLoop);
    const dt=(t-lastTime)/1000;
    lastTime=t;
    moveSnake(dt);
    draw();
}

function moveSnake(dt){
    let head=snake[0];
    dir=targetDir;
    head.x+=dir.x*dt*speed;
    head.y+=dir.y*dt*speed;

    for(let i=1;i<snake.length;i++){
        let s=snake[i];
        let dx=head.x-s.x;
        let dy=head.y-s.y;
        let dist=Math.hypot(dx,dy);
        if(dist>0.1){s.x+=dx*0.2;s.y+=dy*0.2;}
        if(Math.abs(dx)<0.5 && Math.abs(dy)<0.5){
            if(i>1){resetGame();return;}
        }
    }

    // wrap
    if(head.x<0)head.x=w/grid;
    if(head.x>w/grid)head.x=0;
    if(head.y<0)head.y=h/grid;
    if(head.y>h/grid)head.y=0;

    // fruit collision
    for(let i=fruits.length-1;i>=0;i--){
        let f=fruits[i];
        if(Math.hypot(head.x-f.x,head.y-f.y)<1){
            for(let j=0;j<f.value;j++)snake.push({x:head.x, y:head.y, vx:dir.x, vy:dir.y});
            score+=f.value;
            fruits.splice(i,1);
            randFruit();
        }
    }
}

function draw(){
    ctx.fillStyle="#111";
    ctx.fillRect(0,0,w,h);

    // fruits
    for(let f of fruits){
        if(f.value===1)ctx.fillStyle="#f00";
        else if(f.value===3)ctx.fillStyle="#ff0";
        else ctx.fillStyle="#0ff";
        ctx.beginPath();
        ctx.arc(f.x*grid+grid/2,f.y*grid+grid/2,grid/2-2,0,Math.PI*2);
        ctx.fill();
    }

    // snake
    for(let i=0;i<snake.length;i++){
        let s=snake[i];
        ctx.fillStyle=i===0?"#0f0":"#0a0";
        ctx.beginPath();
        ctx.roundRect(s.x*grid,s.y*grid,grid-1,grid-1,4);
        ctx.fill();
    }

    document.getElementById('score').innerText="Score: "+score;
}

// joystick
const joystick=document.getElementById('joystick');
const stick=document.getElementById('stick');
let active=false;
let startX=0,startY=0;

function limitDir(x,y){
    if(Math.abs(x)>Math.abs(y)){
        targetDir={x:x>0?1:-1,y:0};
    }else{
        targetDir={x:0,y:y>0?1:-1};
    }
}

joystick.addEventListener('touchstart',e=>{e.preventDefault();active=true;startX=e.touches[0].clientX;startY=e.touches[0].clientY;});
joystick.addEventListener('touchmove',e=>{
    if(!active) return;
    let tx=e.touches[0].clientX-startX;
    let ty=e.touches[0].clientY-startY;
    let dist=Math.min(40,Math.hypot(tx,ty));
    let angle=Math.atan2(ty,tx);
    stick.style.transform=`translate(${dist*Math.cos(angle)}px,${dist*Math.sin(angle)}px)`;
    limitDir(tx,ty);
});
joystick.addEventListener('touchend',e=>{active=false;stick.style.transform='translate(0,0)';});

document.addEventListener('gesturestart', e => e.preventDefault());
document.addEventListener('dblclick', e => e.preventDefault());
document.addEventListener('touchmove', e => {if(e.scale!==1)e.preventDefault();},{passive:false});

gameLoop();
</script>
</body>
</html>
